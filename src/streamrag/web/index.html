<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>StreamRAG Demo</title>
  <link rel="stylesheet" href="/web/styles.css" />
  </head>
  <body>
    <h1>StreamRAG Demo</h1>
    <p class="muted">Use the buttons below to initialize the database, embed a sample corpus, and run a search.</p>

    <div class="card">
      <div class="row">
        <button id="btn-init" type="button">Apply Schema (/init)</button>
        <span id="init-status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:0.5rem;">
        <button id="btn-embed" type="button">Embed Default Corpus (/embed)</button>
        <span id="embed-status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div id="q-display" class="muted" style="padding-bottom: 10px; color: black">Example query: "Find sentences that are about animals"</div>
      </div>
      <div class="row">
        <label for="k">Top-k:</label>
        <select id="k">
          <option value="3">k = 3</option>
          <option value="5" selected>k = 5</option>
          <option value="8">k = 8</option>
          <option value="10">k = 10</option>
        </select>
        <button id="btn-search" type="button">Search (/search)</button> 
      </div>
      <div id="search-status" class="muted" style="margin-top:0.5rem;"></div>
      <div class="results" id="results"></div>
    </div>

    <div class="card">
      <div class="row" style="padding-bottom: 10px; color: black">LLM query (plus context):</div>
      <div class="row">
        <label for="aq">Question:</label>
        <input id="aq" type="text" placeholder="Ask a question" value="What sentences talk about animals?" />
        <label for="ak">Top-k:</label>
        <select id="ak">
          <option value="3">k = 3</option>
          <option value="5" selected>k = 5</option>
          <option value="8">k = 8</option>
        </select>
        <button id="btn-answer" type="button">Answer (/answer)</button>
      </div>
      <div id="answer-status" class="muted" style="margin-top:0.5rem;"></div>
      <div class="results" id="answer"></div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);

      // Networking
      async function postJSON(url, body) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: body ? JSON.stringify(body) : null,
        });
        const text = await res.text();
        let parsed = null;
        try { parsed = JSON.parse(text); } catch {}
        return { ok: res.ok, status: res.status, statusText: res.statusText, json: parsed, raw: text };
      }

      // UX helpers
      function pickErrorMessage(out) {
        if (!out) return 'Unknown error';
        const j = out.json || {};
        const msg = j.error || j.detail || j.message || j.msg;
        if (msg) return String(msg);
        if (out.raw && String(out.raw).trim()) return String(out.raw).trim();
        return `HTTP ${out.status || ''} ${out.statusText || ''}`.trim();
      }

      function setStatusOk(id, text) {
        const node = el(id);
        node.textContent = text;
        node.className = 'ok';
      }

      function setStatusErr(id, msg) {
        const node = el(id);
        node.className = '';
        node.innerHTML = '';
        const span = document.createElement('span');
        span.className = 'err';
        span.textContent = msg;
        node.appendChild(span);
      }

      function disableAll(...nodes) { nodes.forEach(n => n && (n.disabled = true)); }
      function enableAll(...nodes) { nodes.forEach(n => n && (n.disabled = false)); }

      function renderSearchResults(containerId, data) {
        const results = data?.results || data || [];
        const container = el(containerId);
        container.innerHTML = '';
        if (!results.length) {
          const none = document.createElement('div');
          none.className = 'muted';
          none.textContent = 'No results';
          container.appendChild(none);
          return;
        }
        for (const r of results) {
          const card = document.createElement('div');
          card.className = 'card';
          const sim = (r.similarity ?? r.sim ?? 0).toFixed(3);
          const simDiv = document.createElement('div');
          simDiv.innerHTML = `<strong>sim:</strong> <code>${sim}</code>`;
          const textDiv = document.createElement('div');
          textDiv.textContent = r.text ?? '';
          card.appendChild(simDiv);
          card.appendChild(textDiv);
          container.appendChild(card);
        }
      }

      function renderAnswer(containerId, payload) {
        const box = el(containerId);
        box.innerHTML = '';
        const ans = payload?.answer || '(no answer)';
        const mode = payload?.mode || '(unknown)';
        const maxSim = payload?.max_similarity;
        const sources = payload?.sources || [];
        const div = document.createElement('div');
        div.className = 'card';
        const simInfo = (typeof maxSim === 'number') ? maxSim.toFixed(3) : '';
        const ansDiv = document.createElement('div');
        ansDiv.style.whiteSpace = 'pre-wrap';
        ansDiv.textContent = ans;
        const metaDiv = document.createElement('div');
        metaDiv.className = 'muted';
        metaDiv.style.marginTop = '0.5rem';
        metaDiv.innerHTML = `mode: <code>${mode}</code>${simInfo ? ` Â· max_similarity: <code>${simInfo}</code>` : ''}`;
        div.appendChild(ansDiv);
        div.appendChild(metaDiv);
        box.appendChild(div);
        if (sources.length) {
          const sHead = document.createElement('div');
          sHead.className = 'muted';
          sHead.textContent = 'Sources:';
          box.appendChild(sHead);
          for (const s of sources) {
            const sDiv = document.createElement('div');
            sDiv.className = 'card';
            const sim = (typeof s.similarity === 'number') ? s.similarity.toFixed(3) : (s.similarity ?? '');
            const simDiv = document.createElement('div');
            simDiv.innerHTML = `<strong>sim:</strong> <code>${sim ?? ''}</code>`;
            const textDiv = document.createElement('div');
            textDiv.textContent = s.text ?? '';
            sDiv.appendChild(simDiv);
            sDiv.appendChild(textDiv);
            box.appendChild(sDiv);
          }
        }
      }

      // Events
      el('btn-init').addEventListener('click', async () => {
        const btn = el('btn-init');
        disableAll(btn);
        el('init-status').textContent = 'Running...';
        try {
          const out = await postJSON('/init', {});
          if (out.ok) setStatusOk('init-status', 'Done');
          else setStatusErr('init-status', pickErrorMessage(out));
        } finally {
          enableAll(btn);
        }
      });

      el('btn-embed').addEventListener('click', async () => {
        const btn = el('btn-embed');
        disableAll(btn);
        el('embed-status').textContent = 'Embedding...';
        try {
          const out = await postJSON('/embed', {});
          if (out.ok) {
            const inserted = out.json?.inserted ?? '(unknown)';
            setStatusOk('embed-status', `Inserted ${inserted} rows`);
          } else setStatusErr('embed-status', pickErrorMessage(out));
        } finally {
          enableAll(btn);
        }
      });

      el('btn-search').addEventListener('click', async () => {
        const btn = el('btn-search');
        const kSel = el('k');
        disableAll(btn, kSel);
        el('search-status').textContent = 'Searching...';
        try {
          const q = 'Find sentences that are about animals.';
          const k = parseInt(kSel.value, 10) || 5;
          const out = await postJSON('/search', { query: q, k });
          if (out.ok) {
            setStatusOk('search-status', 'Done');
            renderSearchResults('results', out.json);
          } else setStatusErr('search-status', pickErrorMessage(out));
        } finally {
          enableAll(btn, kSel);
        }
      });

      el('btn-answer').addEventListener('click', async () => {
        const btn = el('btn-answer');
        const qIn = el('aq');
        const kSel = el('ak');
        disableAll(btn, qIn, kSel);
        el('answer-status').textContent = 'Answering...';
        try {
          const q = qIn.value.trim();
          const k = parseInt(kSel.value, 10) || 5;
          const out = await postJSON('/answer', { query: q, k });
          if (out.ok) {
            setStatusOk('answer-status', 'Done');
            renderAnswer('answer', out.json);
          } else setStatusErr('answer-status', pickErrorMessage(out));
        } finally {
          enableAll(btn, qIn, kSel);
        }
      });
    </script>
  </body>
  </html>
